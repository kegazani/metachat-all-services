version: '3.8'

services:
  # EventStoreDB
  eventstore:
    image: eventstore/eventstore:latest
    container_name: metachat-eventstore
    ports:
      - "2113:2113"   # HTTP API
      - "1113:1113"   # TCP
    environment:
      - EVENTSTORE_CLUSTER_SIZE=1
      - EVENTSTORE_RUN_PROJECTIONS=All
      - EVENTSTORE_START_STANDARD_PROJECTIONS=True
      - EVENTSTORE_EXT_TCP_PORT=1113
      - EVENTSTORE_HTTP_PORT=2113
      - EVENTSTORE_INSECURE=True
      - EVENTSTORE_ENABLE_EXTERNAL_TCP=True
      - EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP=True
    volumes:
      - eventstore_data:/var/lib/eventstore
    networks:
      - metachat-network

  # Cassandra
  cassandra:
    image: cassandra:latest
    container_name: metachat-cassandra
    ports:
      - "9042:9042"   # Native transport
      - "9160:9160"   # JMX
    environment:
      - CASSANDRA_CLUSTER_NAME=metachat-cluster
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
    volumes:
      - cassandra_data:/var/lib/cassandra
    networks:
      - metachat-network

  # Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: metachat-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - metachat-network

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: metachat-kafka
    ports:
      - "9092:9092"   # Kafka Broker
      - "29092:29092" # Kafka Broker (for host access)
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      KAFKA_CONFLUENT_SUPPORT_METRICS_ENABLE: false
      KAFKA_JMX_PORT: 9999
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - metachat-network

  # Kong API Gateway
  kong:
    image: kong:latest
    container_name: metachat-kong
    ports:
      - "8000:8000"   # Proxy
      - "8443:8443"   # Proxy SSL
      - "8001:8001"   # Admin API
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stdout
    volumes:
      - ./config/kong:/kong/declarative
    networks:
      - metachat-network
    depends_on:
      - user-service
      - diary-service

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: metachat-user-service
    ports:
      - "8081:8080"   # Service port
    environment:
      - EVENTSTORE_URL=http://eventstore:2113
      - CASSANDRA_HOSTS=cassandra
      - KAFKA_BROKERS=kafka:9092
      - JWT_SECRET=your-secret-key
    depends_on:
      - eventstore
      - cassandra
      - kafka
    networks:
      - metachat-network
    volumes:
      - ./services/user-service:/app

  # Diary Service
  diary-service:
    build:
      context: ./services/diary-service
      dockerfile: Dockerfile
    container_name: metachat-diary-service
    ports:
      - "8082:8080"   # Service port
    environment:
      - EVENTSTORE_URL=http://eventstore:2113
      - CASSANDRA_HOSTS=cassandra
      - KAFKA_BROKERS=kafka:9092
    depends_on:
      - eventstore
      - cassandra
      - kafka
    networks:
      - metachat-network
    volumes:
      - ./services/diary-service:/app

  # Mood Analysis Service
  mood-analysis-service:
    build:
      context: ./services/mood-analysis-service
      dockerfile: Dockerfile
    container_name: metachat-mood-analysis-service
    ports:
      - "50051:50051"   # gRPC port
    environment:
      - KAFKA_BROKERS=kafka:9092
      - MODEL_PATH=/models/rubert-base-cased-sentiment
    depends_on:
      - kafka
    networks:
      - metachat-network
    volumes:
      - ./services/mood-analysis-service:/app
      - mood_models:/models

  # Matching Service
  matching-service:
    build:
      context: ./services/matching-service
      dockerfile: Dockerfile
    container_name: metachat-matching-service
    ports:
      - "8083:8080"   # Service port
    environment:
      - CASSANDRA_HOSTS=cassandra
      - KAFKA_BROKERS=kafka:9092
    depends_on:
      - cassandra
      - kafka
    networks:
      - metachat-network
    volumes:
      - ./services/matching-service:/app

volumes:
  eventstore_data:
  cassandra_data:
  kafka_data:
  mood_models:

networks:
  metachat-network:
    driver: bridge