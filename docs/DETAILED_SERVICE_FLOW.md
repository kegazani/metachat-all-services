# MetaChat - –î–µ—Ç–∞–ª—å–Ω—ã–π Flow –°–µ—Ä–≤–∏—Å–æ–≤

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±—â–∏–π –æ–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±—â–∏–π-–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [Flow 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#flow-1-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
3. [Flow 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ](#flow-2-—Å–æ–∑–¥–∞–Ω–∏–µ-–∑–∞–ø–∏—Å–∏-–≤-–¥–Ω–µ–≤–Ω–∏–∫–µ)
4. [Flow 3: –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è](#flow-3-–∞–Ω–∞–ª–∏–∑-–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è)
5. [Flow 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (Big Five)](#flow-4-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ-–ª–∏—á–Ω–æ—Å—Ç–∏-big-five)
6. [Flow 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö](#flow-5-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö-–¥–∞–Ω–Ω—ã—Ö)
7. [Flow 6: –ü–æ–∏—Å–∫ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π](#flow-6-–ø–æ–∏—Å–∫-–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π)
8. [Flow 7: –ü–æ–¥–±–æ—Ä —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#flow-7-–ø–æ–¥–±–æ—Ä-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
9. [Flow 8: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±—â–µ–Ω–∏–µ](#flow-8-—Å–æ–∑–¥–∞–Ω–∏–µ-–∑–∞–ø—Ä–æ—Å–∞-–Ω–∞-–æ–±—â–µ–Ω–∏–µ)
10. [Flow 9: –ß–∞—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏](#flow-9-—á–∞—Ç-–º–µ–∂–¥—É-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)

---

## –û–±—â–∏–π –æ–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

MetaChat - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–æ–¥–±–æ—Ä–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –¥–Ω–µ–≤–Ω–∏–∫–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

**Frontend:**
- Flutter Mobile App (iOS/Android)

**Backend Services:**
- API Gateway (Go) - :8080
- User Service (Go) - :50051
- Diary Service (Go) - :50052
- Matching Service (Go) - :50053
- Match Request Service (Go) - :50054
- Chat Service (Go) - :50055
- Mood Analysis Service (Python) - :8000
- Personality Service (Python) - :8002
- Analytics Service (Python) - :8001
- Biometric Service (Python) - :8003
- Correlation Service (Python) - :8004

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- Apache Kafka - :9092 (Message Broker)
- PostgreSQL - :5432 (Event Store)
- Apache Cassandra - :9042 (Read Models)
- Redis - :6379 (Cache)
- EventStoreDB - :2113 (Event Sourcing)

---

## Flow 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
```
POST /auth/register
{
  "username": "user123",
  "email": "user@example.com",
  "password": "secure_password",
  "first_name": "John",
  "last_name": "Doe"
}
```

**–î–µ—Ç–∞–ª–∏:**
- –ö–ª–∏–µ–Ω—Ç: Flutter Mobile App
- –ü—Ä–æ—Ç–æ–∫–æ–ª: HTTP REST
- Endpoint: API Gateway :8080

### –®–∞–≥ 2: API Gateway –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. API Gateway –ø–æ–ª—É—á–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è JSON, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è)
3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ User Service —á–µ—Ä–µ–∑ gRPC
4. –í—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥: `RegisterUser(request)`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- –ü—Ä–æ—Ç–æ–∫–æ–ª: gRPC
- Service: User Service
- Port: 50051
- –ú–µ—Ç–æ–¥: `UserService.RegisterUser`

### –®–∞–≥ 3: User Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ username
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ email
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è

2. **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bcrypt/argon2
   - Salt generation
   - Hash storage

3. **–°–æ–∑–¥–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–∞ User:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –¥–ª—è user_id
   - –°–æ–∑–¥–∞–Ω–∏–µ UserAggregate
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è UserCreated

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Event Store:**
   - –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ PostgreSQL/EventStoreDB
   - Event Type: `UserCreated`
   - Payload: {user_id, username, email, first_name, last_name, created_at}
   - Version: 1

5. **–°–æ–∑–¥–∞–Ω–∏–µ Read Model:**
   - –ó–∞–ø–∏—Å—å –≤ Cassandra: `users_by_id`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {id, username, email, first_name, last_name, created_at, updated_at}

6. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka:**
   - Topic: `metachat-user-events`
   - Event: `UserRegistered`
   - Payload: {user_id, username, email, first_name, last_name, timestamp}

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- Event Store: PostgreSQL/EventStoreDB
- Read Model: Cassandra
- Message Broker: Kafka
- Topic: `metachat-user-events`

### –®–∞–≥ 4: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. User Service –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç gRPC –æ—Ç–≤–µ—Ç
2. API Gateway –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ HTTP –æ—Ç–≤–µ—Ç
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: `201 Created` —Å user_id

**Response:**
```json
{
  "user_id": "uuid-here",
  "username": "user123",
  "email": "user@example.com",
  "message": "User registered successfully"
}
```

### –®–∞–≥ 5: –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
**Analytics Service:**
- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ `metachat-user-events`
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ Cassandra

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–∞—Å—Ç—å: ~100-300ms
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–∞—Å—Ç—å: ~500ms-2s

---

## Flow 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
```
POST /diary/entries
Authorization: Bearer <token>
{
  "title": "–ú–æ–π –¥–µ–Ω—å",
  "content": "–°–µ–≥–æ–¥–Ω—è –±—ã–ª –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å. –Ø –≤—Å—Ç—Ä–µ—Ç–∏–ª —Å—Ç–∞—Ä—ã—Ö –¥—Ä—É–∑–µ–π...",
  "tags": ["friends", "happiness"],
  "session_id": "optional-session-uuid"
}
```

**–î–µ—Ç–∞–ª–∏:**
- –ö–ª–∏–µ–Ω—Ç: Flutter Mobile App
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: JWT Bearer Token
- Endpoint: API Gateway :8080

### –®–∞–≥ 2: API Gateway –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT token
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ user_id –∏–∑ token
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è token

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (content)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (min: 10, max: 10000 —Å–∏–º–≤–æ–ª–æ–≤)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ tags (–º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫)

3. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:**
   - –í—ã–∑–æ–≤ Diary Service —á–µ—Ä–µ–∑ gRPC
   - –ú–µ—Ç–æ–¥: `CreateDiaryEntry(request)`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- Service: Diary Service
- Port: 50052
- –ú–µ—Ç–æ–¥: `DiaryService.CreateDiaryEntry`

### –®–∞–≥ 3: Diary Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –¥–ª—è diary_id
   - –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ (–¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞)
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (trim, remove extra spaces)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ user_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–∞ DiaryEntry:**
   - –°–æ–∑–¥–∞–Ω–∏–µ DiaryEntryAggregate
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è DiaryEntryCreated
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: created_at, version

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Event Store:**
   - –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ PostgreSQL/EventStoreDB
   - Event Type: `DiaryEntryCreated`
   - Payload: {
       diary_id,
       user_id,
       title,
       content,
       token_count,
       tags,
       session_id (optional),
       created_at
     }
   - Version: 1
   - Metadata: {correlation_id, causation_id}

4. **–°–æ–∑–¥–∞–Ω–∏–µ Read Model:**
   - –ó–∞–ø–∏—Å—å –≤ Cassandra: `diary_entries_by_id`
   - –ó–∞–ø–∏—Å—å –≤ Cassandra: `diary_entries_by_user_id` (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞)
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       id,
       user_id,
       title,
       content,
       token_count,
       tags,
       created_at,
       updated_at
     }

5. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka:**
   - Topic: `metachat.diary.entry.created`
   - Event: `DiaryEntryCreated`
   - Payload: {
       diary_id,
       user_id,
       title,
       content,
       token_count,
       tags,
       created_at,
       timestamp
     }

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- Event Store: PostgreSQL/EventStoreDB
- Read Models: Cassandra (2 —Ç–∞–±–ª–∏—Ü—ã)
- Message Broker: Kafka
- Topic: `metachat.diary.entry.created`

### –®–∞–≥ 4: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. Diary Service –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç gRPC –æ—Ç–≤–µ—Ç
2. API Gateway –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ HTTP –æ—Ç–≤–µ—Ç
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: `201 Created` —Å diary_id

**Response:**
```json
{
  "diary_id": "uuid-here",
  "user_id": "user-uuid",
  "title": "–ú–æ–π –¥–µ–Ω—å",
  "content": "–°–µ–≥–æ–¥–Ω—è –±—ã–ª –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å...",
  "token_count": 45,
  "tags": ["friends", "happiness"],
  "created_at": "2024-01-15T10:30:00Z"
}
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–∞—Å—Ç—å: ~150-400ms

### –®–∞–≥ 5: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (—Ç—Ä–∏–≥–≥–µ—Ä—ã)

#### 5.1 Mood Analysis Service (Consumer)
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.diary.entry.created`
   - Consumer Group: `mood-analysis-service`
   - Offset: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:**
   - –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è JSON payload
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ: diary_id, user_id, content, token_count

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (>= 10 —Å–∏–º–≤–æ–ª–æ–≤)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ token_count > 0

**–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:** ~50-200ms –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

#### 5.2 Analytics Service (Consumer)
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.diary.entry.created`
   - Consumer Group: `analytics-service`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫: total_entries, entries_today, avg_entry_length
   - –ó–∞–ø–∏—Å—å –≤ Cassandra: `user_statistics`

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~100-300ms

#### 5.3 Personality Service (Consumer)
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.diary.entry.created`
   - Consumer Group: `personality-service`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤:**
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ total_tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ª–∏—á–Ω–æ—Å—Ç–∏

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

---

## Flow 3: –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è

### –®–∞–≥ 1: Mood Analysis Service –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. Kafka Consumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `metachat.diary.entry.created`
2. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è payload
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: {diary_id, user_id, content, token_count}

**–í—Ä–µ–º—è:** ~50-200ms –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è

### –®–∞–≥ 2: –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞:**
   - –£–¥–∞–ª–µ–Ω–∏–µ URL-–∞–¥—Ä–µ—Å–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–º–æ—Ç–∏–∫–æ–Ω–æ–≤)
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫

2. **–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è:**
   - –†–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
   - –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ (–¥–ª—è –º–æ–¥–µ–ª–∏)
   - –û–±—Ä–µ–∑–∫–∞ –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (512 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π)

3. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –º–æ–¥–µ–ª–∏:**
   - –°–æ–∑–¥–∞–Ω–∏–µ input tensors
   - Padding/truncation
   - Token IDs mapping

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-50ms

### –®–∞–≥ 3: AI –∞–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **Sentiment Analysis (Transformer Model):**
   - –ú–æ–¥–µ–ª—å: HuggingFace Transformers (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cardiffnlp/twitter-roberta-base-sentiment-latest`)
   - Input: –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
   - Output: sentiment score (positive/neutral/negative)
   - Confidence: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

2. **Emotion Classification (Plutchik Model):**
   - –ú–æ–¥–µ–ª—å: Fine-tuned transformer –¥–ª—è 8 –±–∞–∑–æ–≤—ã—Ö —ç–º–æ—Ü–∏–π
   - 8 —ç–º–æ—Ü–∏–π Plutchik:
     - Joy (–†–∞–¥–æ—Å—Ç—å) - +valence, +arousal
     - Trust (–î–æ–≤–µ—Ä–∏–µ) - +valence, low arousal
     - Fear (–°—Ç—Ä–∞—Ö) - -valence, high arousal
     - Surprise (–£–¥–∏–≤–ª–µ–Ω–∏–µ) - neutral, high arousal
     - Sadness (–ì—Ä—É—Å—Ç—å) - -valence, low arousal
     - Disgust (–û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ) - -valence, -arousal
     - Anger (–ì–Ω–µ–≤) - -valence, high arousal
     - Anticipation (–ü—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–µ) - +valence, +arousal
   - Output: emotion_vector[8] - –º–∞—Å—Å–∏–≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π —ç–º–æ—Ü–∏–∏

3. **Valence –∏ Arousal —Ä–∞—Å—á–µ—Ç:**
   - Valence: –æ—Ç -1 (–Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–µ) –¥–æ +1 (–ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ)
     - –§–æ—Ä–º—É–ª–∞: weighted sum —ç–º–æ—Ü–∏–π —Å —É—á–µ—Ç–æ–º –∏—Ö –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏
   - Arousal: –æ—Ç -1 (—Å–ø–æ–∫–æ–π–Ω–æ–µ) –¥–æ +1 (–≤–æ–∑–±—É–∂–¥–µ–Ω–Ω–æ–µ)
     - –§–æ—Ä–º—É–ª–∞: weighted sum —ç–º–æ—Ü–∏–π —Å —É—á–µ—Ç–æ–º –∏—Ö —É—Ä–æ–≤–Ω—è –≤–æ–∑–±—É–∂–¥–µ–Ω–∏—è

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~200-800ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –∏ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞)

### –®–∞–≥ 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–º –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **Topic Extraction:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ NLP –±–∏–±–ª–∏–æ—Ç–µ–∫ (spaCy, NLTK)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–µ–º–∞–º (work, relationships, health, etc.)

2. **Keyword Extraction:**
   - TF-IDF –∞–Ω–∞–ª–∏–∑
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∏–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç–æ–ø-—Å–ª–æ–≤

3. **Topic Classification:**
   - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
   - –ü—Ä–∏–º–µ—Ä—ã: work, family, friends, health, achievements, stress

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms

### –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–π —ç–º–æ—Ü–∏–∏:**
   - –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤ emotion_vector
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dominant_emotion

2. **–†–∞—Å—á–µ—Ç confidence:**
   - –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞ (–¥–ª–∏–Ω–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   ```json
   {
     "user_id": "uuid",
     "diary_id": "uuid",
     "emotion_vector": [0.1, 0.3, 0.05, 0.1, 0.05, 0.02, 0.03, 0.35],
     "dominant_emotion": "anticipation",
     "valence": 0.65,
     "arousal": 0.45,
     "confidence": 0.82,
     "topics": ["friends", "social"],
     "keywords": ["–≤—Å—Ç—Ä–µ—Ç–∏–ª", "–¥—Ä—É–∑—å—è", "—Ä–∞–¥–æ—Å—Ç—å"],
     "analyzed_at": "2024-01-15T10:30:15Z"
   }
   ```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-30ms

### –®–∞–≥ 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Cassandra:**
   - –¢–∞–±–ª–∏—Ü–∞: `mood_analyses`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       entry_id,
       user_id,
       emotion_vector,
       dominant_emotion,
       valence,
       arousal,
       confidence,
       topics,
       keywords,
       analyzed_at
     }
   - TTL: –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ)

2. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka:**
   - Topic: `metachat.mood.analyzed`
   - Event: `MoodAnalyzed`
   - Payload: –ø–æ–ª–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 7: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ü—Ä–æ—Ü–µ—Å—Å:**

–ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ —É–¥–∞–ª—Å—è:
1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
2. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è: `metachat.mood.analysis.failed`
3. Payload: {user_id, diary_id, error, timestamp}
4. Retry –º–µ—Ö–∞–Ω–∏–∑–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Flow 3:** ~400-1500ms

---

## Flow 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ (Big Five)

### –®–∞–≥ 1: Personality Service –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.mood.analyzed`
   - Consumer Group: `personality-service`

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:**
   - –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è payload
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ: user_id, emotion_vector, valence, arousal, topics, diary_id

**–í—Ä–µ–º—è:** ~50-200ms –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è

### –®–∞–≥ 2: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: –≤—Å–µ mood_analyses –¥–ª—è user_id
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: –≤—Å–µ diary_entries –¥–ª—è user_id
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: —Ç–µ–∫—É—â–∏–µ Big Five –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

2. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è —ç–º–æ—Ü–∏–π:**
   - –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ emotion_vector
   - –§–æ—Ä–º—É–ª–∞: `new_avg = 0.7 * old_avg + 0.3 * new_emotion`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤ –ø–∞–º—è—Ç–∏/–∫—ç—à–µ

3. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–µ–º:**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–º (topic distribution)
   - –ü–æ–¥—Å—á–µ—Ç —á–∞—Å—Ç–æ—Ç—ã –∫–∞–∂–¥–æ–π —Ç–µ–º—ã
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

4. **–ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤:**
   - –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ token_count –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ total_tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~100-300ms

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

**–£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞:**
- total_tokens >= 50
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∏–º–µ–µ—Ç Big Five –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π

**–£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞:**
- total_tokens —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –Ω–∞ >= 100 —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
- –ò–õ–ò –ø—Ä–æ—à–ª–æ >= 7 –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
- –ò —Ç–µ–∫—É—â–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å < 0.7 (–Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞)

**–ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Cassandra (–±–µ–∑ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ Big Five)
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-50ms

### –®–∞–≥ 4: –†–∞—Å—á–µ—Ç Big Five (OCEAN)
**–ü—Ä–æ—Ü–µ—Å—Å:**

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π emotion_vector[8]
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º (topic distribution)
- –°—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è valence –∏ arousal
- –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–¥–ª–∏–Ω–∞ –∑–∞–ø–∏—Å–µ–π, —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø–∏—Å–µ–π)

**–†–∞—Å—á–µ—Ç –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞:**

1. **Openness (O) - –û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –æ–ø—ã—Ç—É:**
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
     - –í—ã—Å–æ–∫–∏–π surprise –≤ emotion_vector
     - –í—ã—Å–æ–∫–∏–π anticipation –≤ emotion_vector
     - –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ —Ç–µ–º—ã (art, music, philosophy)
     - –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ (vocabulary diversity)
   - –§–æ—Ä–º—É–ª–∞: weighted combination –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.0 - 1.0

2. **Conscientiousness (C) - –î–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç—å:**
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
     - –í—ã—Å–æ–∫–∏–π trust –≤ emotion_vector
     - –¢–µ–º—ã: work, achievements, goals
     - –î–ª–∏–Ω–∞ –∑–∞–ø–∏—Å–µ–π (–±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ = –±–æ–ª–µ–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
     - –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
   - –§–æ—Ä–º—É–ª–∞: weighted combination –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.0 - 1.0

3. **Extraversion (E) - –≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è:**
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
     - –í—ã—Å–æ–∫–∏–π joy –≤ emotion_vector
     - –í—ã—Å–æ–∫–∏–π surprise –≤ emotion_vector
     - –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã (friends, parties, social events)
     - –í—ã—Å–æ–∫–∏–π arousal
   - –§–æ—Ä–º—É–ª–∞: weighted combination –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.0 - 1.0

4. **Agreeableness (A) - –î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
     - –í—ã—Å–æ–∫–∏–π trust –≤ emotion_vector
     - –í—ã—Å–æ–∫–∏–π joy –≤ emotion_vector
     - –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã
     - –ù–∏–∑–∫–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —ç–º–æ—Ü–∏–∏ (anger, disgust)
   - –§–æ—Ä–º—É–ª–∞: weighted combination –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.0 - 1.0

5. **Neuroticism (N) - –ù–µ–π—Ä–æ—Ç–∏–∑–º:**
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
     - –í—ã—Å–æ–∫–∏–π fear –≤ emotion_vector
     - –í—ã—Å–æ–∫–∏–π sadness –≤ emotion_vector
     - –í—ã—Å–æ–∫–∏–π anger –≤ emotion_vector
     - –¢–µ–º—ã —Å—Ç—Ä–µ—Å—Å–∞ (stress, anxiety, problems)
     - –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
   - –§–æ—Ä–º—É–ª–∞: weighted combination –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
   - –î–∏–∞–ø–∞–∑–æ–Ω: 0.0 - 1.0

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞:**
- –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dominant_trait

**–†–∞—Å—á–µ—Ç confidence:**
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç:
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
  - –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ç–µ–º
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤
  - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–π
- –§–æ—Ä–º—É–ª–∞: `confidence = min(1.0, (tokens / 500) * 0.5 + (entries / 20) * 0.3 + consistency * 0.2)`

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Cassandra:**
   - –¢–∞–±–ª–∏—Ü–∞: `user_personality`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       user_id,
       openness,
       conscientiousness,
       extraversion,
       agreeableness,
       neuroticism,
       dominant_trait,
       confidence,
       model_version,
       tokens_analyzed,
       calculated_at,
       updated_at
     }

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ User Service:**
   - –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka
   - Topic: `metachat.personality.assigned` (–ø–µ—Ä–≤—ã–π —Ä–∞–∑) –∏–ª–∏ `metachat.personality.updated` (–ø–µ—Ä–µ—Å—á–µ—Ç)
   - Payload: –≤—Å–µ Big Five –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 6: User Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.personality.assigned` –∏–ª–∏ `metachat.personality.updated`
   - Consumer Group: `user-service`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Read Model –≤ Cassandra: `users_by_id`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `big_five` –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è:**
   - Topic: `metachat-user-events`
   - Event: `UserPersonalityAssigned` –∏–ª–∏ `UserPersonalityUpdated`

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 7: –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã

**Analytics Service:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤

**Matching Service:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ User Portrait –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–µ—Ä–µ—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)

**–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Flow 4:** ~400-1200ms

---

## Flow 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 1: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:**
   - –£–º–Ω—ã–µ —á–∞—Å—ã (Apple Watch, Fitbit, etc.)
   - –§–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–∫–µ—Ä—ã
   - –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ HealthKit/Google Fit)

2. **HTTP –∑–∞–ø—Ä–æ—Å:**
   ```
   POST /biometric/data
   Authorization: Bearer <token>
   {
     "user_id": "uuid",
     "heart_rate": 72,
     "sleep_data": {
       "duration_hours": 7.5,
       "quality_score": 0.85,
       "deep_sleep_hours": 2.0
     },
     "activity": {
       "steps": 8500,
       "calories_burned": 450,
       "active_minutes": 30
     },
     "device_id": "apple-watch-123",
     "timestamp": "2024-01-15T08:00:00Z"
   }
   ```

**–î–µ—Ç–∞–ª–∏:**
- Endpoint: Biometric Service :8003
- –ü—Ä–æ—Ç–æ–∫–æ–ª: HTTP REST
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: JWT Bearer Token

### –®–∞–≥ 2: Biometric Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT token
   - –í–∞–ª–∏–¥–∞—Ü–∏—è user_id
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π (heart_rate: 30-220, etc.)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL:**
   - –¢–∞–±–ª–∏—Ü–∞: `biometric_data`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       id,
       user_id,
       heart_rate,
       sleep_duration,
       sleep_quality,
       steps,
       calories,
       active_minutes,
       device_id,
       recorded_at,
       created_at
     }

3. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka:**
   - Topic: `metachat.biometric.data.received`
   - Event: `BiometricDataReceived`
   - Payload: {
       user_id,
       heart_rate,
       sleep_data,
       activity,
       device_id,
       timestamp
     }

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 3: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**Response:**
```json
{
  "status": "success",
  "data_id": "uuid",
  "message": "Biometric data saved"
}
```

### –®–∞–≥ 4: Correlation Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Kafka:**
   - Topic: `metachat.biometric.data.received`
   - Consumer Group: `correlation-service`

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏/Redis
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `biometric_cache:{user_id}` -> —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∑–∞–ø–∏—Å–µ–π
   - TTL: 30 –¥–Ω–µ–π

3. **–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:**
   - Correlation Service —Ç–∞–∫–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `metachat.mood.analyzed`
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: `mood_cache:{user_id}`

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

---

## Flow 6: –ü–æ–∏—Å–∫ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π

### –®–∞–≥ 1: Correlation Service –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**

Correlation Service –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –¥–≤–∞ —Ç–æ–ø–∏–∫–∞:
1. `metachat.mood.analyzed` - –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
2. `metachat.biometric.data.received` - –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

### –®–∞–≥ 2: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:**
   - –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `metachat.mood.analyzed`:
     - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis: `mood_cache:{user_id}`
     - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –∑–∞–ø–∏—Å–µ–π
     - –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å: {timestamp, valence, arousal, dominant_emotion}

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–æ–º–µ—Ç—Ä–∏–∏:**
   - –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `metachat.biometric.data.received`:
     - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis: `biometric_cache:{user_id}`
     - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 30 –∑–∞–ø–∏—Å–µ–π
     - –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å: {timestamp, heart_rate, sleep_data, activity}

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-50ms –Ω–∞ —Å–æ–±—ã—Ç–∏–µ

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
   - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: >= 10 –∑–∞–ø–∏—Å–µ–π
   - –ë–∏–æ–º–µ—Ç—Ä–∏—è: >= 14 –¥–Ω–µ–π –¥–∞–Ω–Ω—ã—Ö
   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–∫–Ω–µ

2. **–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**
   - –ü—Ä–æ—Å—Ç–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-30ms

### –®–∞–≥ 4: –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (mood –∏ biometric)
   - –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

2. **–†–∞—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π:**

   **a) Heart Rate vs Valence:**
   - Pearson correlation coefficient
   - –§–æ—Ä–º—É–ª–∞: `r = Œ£((x - xÃÑ)(y - »≥)) / ‚àö(Œ£(x - xÃÑ)¬≤ * Œ£(y - »≥)¬≤)`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏: p-value < 0.05
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è: |r| > 0.3

   **b) Sleep Quality vs Arousal:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏

   **c) Activity vs Valence:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏

3. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏:**
   - `heart_rate_valence` - –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É –ø—É–ª—å—Å–æ–º –∏ –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
   - `sleep_arousal` - –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É —Å–Ω–æ–º –∏ –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ–º
   - `activity_valence` - –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å—é

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~100-500ms

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Cassandra:**
   - –¢–∞–±–ª–∏—Ü–∞: `correlations`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       user_id,
       correlation_type,
       correlation_score,
       p_value,
       mood_data_summary,
       biometric_data_summary,
       discovered_at,
       confidence
     }

2. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka:**
   - Topic: `metachat.correlation.discovered`
   - Event: `CorrelationDiscovered`
   - Payload: {
       user_id,
       correlation_type,
       mood_data,
       biometric_data,
       correlation_score,
       p_value,
       timestamp
     }

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 6: –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã

**Analytics Service:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤

**User Service (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π

**–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Flow 6:** ~200-1000ms (–ø–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö)

---

## Flow 7: –ü–æ–¥–±–æ—Ä —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
**–ü—Ä–æ—Ü–µ—Å—Å:**

```
GET /matching/recommendations?user_id=uuid&limit=10
Authorization: Bearer <token>
```

**–î–µ—Ç–∞–ª–∏:**
- Endpoint: API Gateway :8080
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: Matching Service :50053

### –®–∞–≥ 2: Matching Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: `users_by_id` -> user_id
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ: big_five, modalities, user_id

2. **–ó–∞–≥—Ä—É–∑–∫–∞ User Portrait:**
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: `user_portraits`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       user_id,
       big_five: {O, C, E, A, N},
       emotion_vector_avg,
       topic_distribution,
       last_updated
     }

3. **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
   - –ó–∞–ø—Ä–æ—Å –∫ Cassandra: –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∏–ª–∏ –∏–∑ –∫—ç—à–∞)
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç—å—é

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~100-300ms

### –®–∞–≥ 3: –†–∞—Å—á–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏
**–ü—Ä–æ—Ü–µ—Å—Å:**

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è similarity score:

1. **Big Five Similarity:**
   - –í–µ–∫—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: [O1, C1, E1, A1, N1]
   - –í–µ–∫—Ç–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: [O2, C2, E2, A2, N2]
   - Cosine Similarity: `cos(Œ∏) = (A¬∑B) / (||A|| * ||B||)`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: 0.0 - 1.0

2. **Emotion Vector Similarity:**
   - Cosine Similarity –º–µ–∂–¥—É —Å—Ä–µ–¥–Ω–∏–º–∏ emotion_vector
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: 0.0 - 1.0

3. **Topic Overlap:**
   - Jaccard Index: `J(A,B) = |A ‚à© B| / |A ‚à™ B|`
   - –ì–¥–µ A –∏ B - –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: 0.0 - 1.0

4. **Final Score:**
   - –§–æ—Ä–º—É–ª–∞: `score = 0.4 * big_five_sim + 0.3 * emotion_sim + 0.3 * topic_overlap`
   - –í–µ—Å–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms –Ω–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞

### –®–∞–≥ 4: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:**
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ final_score (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥: score >= 0.3
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö match requests

3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:**
   - –í—ã–±–æ—Ä top N –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (limit –∏–∑ –∑–∞–ø—Ä–æ—Å–∞)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-50ms

### –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

```json
{
  "user_id": "uuid",
  "recommendations": [
    {
      "user_id": "candidate-uuid-1",
      "similarity_score": 0.85,
      "big_five_similarity": 0.82,
      "emotion_similarity": 0.88,
      "topic_overlap": 0.75,
      "common_topics": ["work", "fitness", "travel"]
    },
    {
      "user_id": "candidate-uuid-2",
      "similarity_score": 0.78,
      ...
    }
  ],
  "total_candidates": 150,
  "generated_at": "2024-01-15T10:30:00Z"
}
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-30ms

### –®–∞–≥ 6: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**Response:** `200 OK` —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

**–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Flow 7:** ~200-600ms

---

## Flow 8: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±—â–µ–Ω–∏–µ

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
**–ü—Ä–æ—Ü–µ—Å—Å:**

```
POST /match-requests
Authorization: Bearer <token>
{
  "from_user_id": "uuid-1",
  "to_user_id": "uuid-2",
  "message": "–ü—Ä–∏–≤–µ—Ç! –•–æ—Ç–µ–ª –±—ã –ø–æ–æ–±—â–∞—Ç—å—Å—è"
}
```

**–î–µ—Ç–∞–ª–∏:**
- Endpoint: API Gateway :8080
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: Match Request Service :50054

### –®–∞–≥ 2: Match Request Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT token
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ from_user_id —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç token
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ to_user_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∑–∞–ø—Ä–æ—Å –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –¥–ª—è request_id
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL: `match_requests`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       id,
       from_user_id,
       to_user_id,
       message,
       status: "pending",
       created_at,
       updated_at
     }

3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
   - –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Kafka/NATS)
   - Push notification –¥–ª—è to_user_id (—á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ push service)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms

### –®–∞–≥ 3: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**Response:**
```json
{
  "request_id": "uuid",
  "from_user_id": "uuid-1",
  "to_user_id": "uuid-2",
  "status": "pending",
  "created_at": "2024-01-15T10:30:00Z"
}
```

### –®–∞–≥ 4: –ü—Ä–∏–Ω—è—Ç–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

–ï—Å–ª–∏ to_user_id –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å:

```
PUT /match-requests/{request_id}/accept
Authorization: Bearer <token>
```

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ PostgreSQL: status = "accepted"
   - –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ (—Å–º. Flow 9)

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:**
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ from_user_id –æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–ø—Ä–æ—Å–∞

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms

---

## Flow 9: –ß–∞—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –®–∞–≥ 1: –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**

```
POST /chats/{chat_id}/messages
Authorization: Bearer <token>
{
  "content": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
  "sender_id": "uuid-1"
}
```

**–î–µ—Ç–∞–ª–∏:**
- Endpoint: API Gateway :8080
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: Chat Service :50055

### –®–∞–≥ 2: Chat Service –æ–±—Ä–∞–±–æ—Ç–∫–∞
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT token
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ sender_id —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç token
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ chat_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ sender_id —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —á–∞—Ç–∞

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID –¥–ª—è message_id
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PostgreSQL: `messages`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {
       id,
       chat_id,
       sender_id,
       content,
       created_at,
       read_at: null
     }

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞:**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_message_at –≤ —Ç–∞–±–ª–∏—Ü–µ `chats`
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ unread_count –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-150ms

### –®–∞–≥ 3: WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket:**
   - Chat Service –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket Gateway
   - –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

2. **Fallback:**
   - –ï—Å–ª–∏ WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è push notification

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-50ms

### –®–∞–≥ 4: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
**Response:**
```json
{
  "message_id": "uuid",
  "chat_id": "uuid",
  "sender_id": "uuid-1",
  "content": "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
  "created_at": "2024-01-15T10:30:00Z"
}
```

### –®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
**–ü—Ä–æ—Ü–µ—Å—Å:**

```
GET /chats/{chat_id}/messages?page=1&limit=50
Authorization: Bearer <token>
```

1. **–ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ:**
   - –ó–∞–ø—Ä–æ—Å –∫ PostgreSQL: `messages` WHERE chat_id = ?
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ created_at DESC
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è

2. **–û—Ç–≤–µ—Ç:**
   ```json
   {
     "chat_id": "uuid",
     "messages": [
       {
         "message_id": "uuid-1",
         "sender_id": "uuid-1",
         "content": "–ü—Ä–∏–≤–µ—Ç!",
         "created_at": "2024-01-15T10:30:00Z"
       },
       ...
     ],
     "page": 1,
     "limit": 50,
     "total": 150
   }
   ```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~50-200ms

---

## –û–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**Retry –º–µ—Ö–∞–Ω–∏–∑–º:**
- Kafka consumers: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å exponential backoff
- HTTP –∑–∞–ø—Ä–æ—Å—ã: retry –¥–æ 3 —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

**Circuit Breaker:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è cached –æ—Ç–≤–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞

**Dead Letter Queue:**
- –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ DLQ
- –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–æ–±—ã—Ç–∏–π
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–µ–π Kafka

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (JSON)
- Correlation ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –£—Ä–æ–≤–Ω–∏: DEBUG, INFO, WARN, ERROR

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- User sessions
- –ß–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ (user profiles)
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (correlation cache)

**TTL:**
- Sessions: 24 —á–∞—Å–∞
- User profiles: 1 —á–∞—Å
- Correlation data: 30 –¥–Ω–µ–π

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã stateless (–∫—Ä–æ–º–µ Event Store)
- Kafka –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ consumers
- Load balancing —á–µ—Ä–µ–∑ API Gateway

**–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è AI —Å–µ—Ä–≤–∏—Å–æ–≤ (–±–æ–ª—å—à–µ CPU/GPU)
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| Flow | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–∞—Å—Ç—å | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–∞—Å—Ç—å | –û–±—â–µ–µ –≤—Ä–µ–º—è |
|------|----------------|-------------------|-------------|
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | 100-300ms | 500ms-2s | 600ms-2.3s |
| –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ | 150-400ms | 400ms-1.5s | 550ms-1.9s |
| –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è | - | 400ms-1.5s | 400ms-1.5s |
| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ | - | 400ms-1.2s | 400ms-1.2s |
| –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ | 50-150ms | 50-150ms | 100-300ms |
| –ü–æ–∏—Å–∫ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π | - | 200ms-1s | 200ms-1s |
| –ü–æ–¥–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | 200-600ms | - | 200-600ms |
| –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ | 50-200ms | 10-50ms | 60-250ms |
| –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è | 50-150ms | 10-50ms | 60-200ms |

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π flow –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ MetaChat. –ö–∞–∂–¥—ã–π flow —Ä–∞–∑–±–∏—Ç –Ω–∞ —à–∞–≥–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º:

- –í—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –í—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –í—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö:
- Event-Driven Architecture
- Microservices
- CQRS (Command Query Responsibility Segregation)
- Event Sourcing
- AI/ML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö


