# Архитектура MetaChat

## Обзор системы

MetaChat - это платформа для ведения дневника с анализом эмоционального состояния и рекомендациями на основе схожести пользователей. Система построена на микросервисной архитектуре с использованием event sourcing для обеспечения отказоустойчивости и масштабируемости.

## Архитектурные компоненты

### 1. API Gateway
- **Технология**: Kong/Traefik
- **Назначение**: Единая точка входа для всех клиентских запросов, маршрутизация к соответствующим микросервисам, аутентификация и авторизация

### 2. Микросервисы

#### 2.1. User Service
- **Язык**: Go
- **Назначение**: Управление пользователями, их профилями и портретами
- **Основные функции**:
  - Регистрация и аутентификация пользователей
  - Управление профилем пользователя
  - Хранение и обновление портрета пользователя
- **База данных**: EventStoreDB (event sourcing), Cassandra (read models)

#### 2.2. Diary Service
- **Язык**: Go
- **Назначение**: Управление записями дневника пользователей
- **Основные функции**:
  - CRUD операции с записями дневника
  - Поиск и фильтрация записей
- **База данных**: EventStoreDB (event sourcing), Cassandra (read models)

#### 2.3. Mood Analysis Service
- **Язык**: Python
- **Назначение**: Анализ эмоционального состояния на основе записей дневника
- **Основные функции**:
  - Анализ текста на предмет эмоциональной окраски с использованием предобученной модели RuBERT
  - Агрегация данных по временным промежуткам (день/неделя/месяц)
  - Обновление портрета пользователя на основе анализа
- **База данных**: EventStoreDB (чтение событий), Kafka (публикация результатов анализа)

#### 2.4. Matching Service
- **Язык**: Go
- **Назначение**: Поиск похожих пользователей и формирование рекомендаций
- **Основные функции**:
  - Расчет схожести пользователей на основе их портретов
  - Поиск пользователей с похожими интересами и эмоциональными профилями
  - Формирование рекомендаций контента
- **База данных**: Cassandra (хранение портретов пользователей и результатов мэтчинга)

### 3. Базы данных

#### 3.1. EventStoreDB
- **Назначение**: Хранение событий системы в хронологическом порядке (event sourcing)
- **Преимущества**: 
  - Полная история изменений состояния системы
  - Возможность воспроизведения событий для восстановления состояния
  - Отказоустойчивость и масштабируемость

#### 3.2. Cassandra
- **Назначение**: Хранение read-моделей для быстрого доступа к данным
- **Преимущества**:
  - Высокая производительность чтения
  - Горизонтальная масштабируемость
  - Поддержка репликации для отказоустойчивости

### 4. Message Broker

#### 4.1. Apache Kafka
- **Назначение**: Асинхронная коммуникация между микросервисами
- **Преимущества**:
  - Гарантированная доставка сообщений
  - Высокая пропускная способность
  - Масштабируемость
  - Сохранение порядка сообщений в рамках раздела

### 5. Мобильное приложение

#### 5.1. iOS приложение (Swift)
- **Назначение**: Клиентское приложение для взаимодействия с системой
- **Основные функции**:
  - Создание и просмотр записей дневника
  - Просмотр анализа эмоционального состояния
  - Просмотр портрета пользователя
  - Получение рекомендаций (пользователи и контент)

## Потоки данных

### 1. Регистрация пользователя
1. Пользователь регистрируется через мобильное приложение
2. Запрос поступает через API Gateway в User Service
3. User Service создает событие UserRegistered в EventStoreDB
4. User Service создает read-модель пользователя в Cassandra

### 2. Создание записи в дневнике
1. Пользователь создает запись через мобильное приложение
2. Запрос поступает через API Gateway в Diary Service
3. Diary Service создает событие DiaryEntryCreated в EventStoreDB
4. Diary Service создает read-модель записи в Cassandra
5. Diary Service публикует событие DiaryEntryCreated в Kafka

### 3. Анализ настроения
1. Mood Analysis Service подписан на события DiaryEntryCreated/Updated в Kafka
2. При получении события, сервис анализирует текст записи с помощью RuBERT
3. Результаты анализа агрегируются по временным промежуткам
4. На основе анализа обновляется портрет пользователя
5. Mood Analysis Service публикует событие MoodAnalyzed в Kafka

### 4. Обновление портрета пользователя
1. User Service подписан на события MoodAnalyzed в Kafka
2. При получении события, сервис обновляет портрет пользователя в Cassandra
3. User Service создает событие UserPortraitUpdated в EventStoreDB

### 5. Поиск похожих пользователей
1. Пользователь запрашивает рекомендации через мобильное приложение
2. Запрос поступает через API Gateway в Matching Service
3. Matching Service получает портрет текущего пользователя из Cassandra
4. Сервис сравнивает портрет с другими пользователями, используя алгоритмы схожести
5. Результаты (похожие пользователи) возвращаются в мобильное приложение

### 6. Рекомендации контента
1. Matching Service анализирует интересы пользователя и его портрет
2. На основе анализа формируются рекомендации контента
3. Рекомендации возвращаются в мобильное приложение

## Безопасность

### 1. Аутентификация и авторизация
- JWT токены для аутентификации пользователей
- Ролевая модель доступа к ресурсам
- Проверка прав доступа на уровне API Gateway

### 2. Защита данных
- Шифрование данных при передаче (TLS/SSL)
- Хранение паролей в захешированном виде
- Регулярное резервное копирование данных

## Масштабируемость

### 1. Горизонтальное масштабирование
- Каждый микросервис может масштабироваться независимо
- Использование контейнеризации (Docker) и оркестрации (Kubernetes)
- Автоматическое масштабирование на основе нагрузки

### 2. Балансировка нагрузки
- Распределение запросов между экземплярами сервисов
- Использование health check для мониторинга состояния сервисов

## Отказоустойчивость

### 1. Резервирование
- Репликация данных в Cassandra
- Резервирование EventStoreDB
- Использование нескольких брокеров Kafka

### 2. Обработка сбоев
- Повторные попытки при временных сбоях
- Circuit Breaker pattern для предотвращения каскадных сбоев
- Очереди для обработки пиковых нагрузок

## Мониторинг и логирование

### 1. Сбор метрик
- Сбор метрик производительности сервисов
- Мониторинг состояния баз данных
- Отслеживание бизнес-метрик

### 2. Централизованное логирование
- Сбор логов со всех сервисов в единую систему
- Анализ логов для выявления проблем
- Оповещения о критических событиях

## Будущие улучшения

### 1. Расширение функционала
- Добавление групповых чатов
- Интеграция с другими социальными сетями
- Расширенные аналитические дашборды

### 2. Оптимизация производительности
- Внедрение кэширования на различных уровнях
- Оптимизация алгоритмов мэтчинга
- Улучшение производительности базы данных

### 3. Улучшение безопасности
- Внедрение многофакторной аутентификации
- Улучшение защиты персональных данных
- Регулярные аудиты безопасности