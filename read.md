# Курсовая работа: Эмоциональный портрет пользователя через личный дневник

## Общее видение проекта

Система представляет собой платформу для ведения личного дневника с AI-анализом эмоционального состояния и построением психологического профиля пользователя. Ключевая идея — накопление данных о человеке через текст и (в перспективе) биометрию для создания динамического эмоционального портрета.

## Гибкая технологическая архитектура

Система построена на гибких технологических решениях, обеспечивающих максимальное удобство разработки и масштабирования:

- **Go** для высокопроизводительных микросервисов
- **Python** для ML-компонентов и сложной обработки данных
- **Swift** для нативного мобильного приложения
- **EventStoreDB** для event sourcing с возможностью легкого масштабирования
- **Cassandra** для read-моделей с гибкой схемой данных
- **Kafka** для надежной асинхронной коммуникации
- **Kong/Traefik** как гибкий API Gateway

---

## Архитектура системы

### Общая схема

Система строится на принципах event sourcing, где каждое действие пользователя (запись в дневник, редактирование, удаление) сохраняется как неизменяемое событие. Это позволяет восстановить состояние на любой момент времени и отслеживать динамику изменений.

**Основные компоненты:**
- API Gateway — единая точка входа, маршрутизация запросов
- Event Store — хранилище событий (основа event sourcing)
- Message Broker — асинхронная коммуникация между сервисами
- Набор микросервисов, каждый отвечает за свою доменную область

---

## Микросервисы и их ответственность

### 1. User Service
Управление пользователями и аутентификацией.

**События, которые генерирует:**
- UserRegistered
- UserProfileUpdated
- UserArchetypeAssigned
- UserArchetypeUpdated
- UserModalitiesUpdated

**Хранит:** профиль пользователя, настройки приватности, текущий архетип, накопленная статистика токенов, информация о подключенных модальностях.

**Взаимодействие:** получает события от Archetype Service для обновления профиля, обменивается данными с другими сервисами для построения полного портрета пользователя.

### 2. Diary Service
Основной сервис для работы с записями дневника.

**События:**
- DiaryEntryCreated
- DiaryEntryUpdated
- DiaryEntryDeleted
- DiarySessionStarted
- DiarySessionEnded

**Модель данных записи:**
- ID записи
- ID пользователя
- временная метка создания
- временная метка изменения
- текст записи
- количество токенов
- ID сессии (группировка по сеансам общения с дневником)

**Важно:** сервис не хранит состояние напрямую — только события. Текущее состояние (проекция) восстанавливается из событий или хранится в read-модели для быстрого доступа.

### 3. Mood Analysis Service
Анализ эмоционального состояния по тексту с агрегацией по разным временным промежуткам.

**Получает события:**
- DiaryEntryCreated
- DiaryEntryUpdated
- DailyAggregationTriggered
- WeeklyAggregationTriggered
- MonthlyAggregationTriggered

**Генерирует события:**
- MoodAnalyzed (содержит: ID записи, вектор эмоций, доминирующая эмоция, уверенность модели)
- DailyMoodAggregated
- WeeklyMoodAggregated
- MonthlyMoodAggregated
- UserPortraitUpdated

**Модель анализа настроения:** рассмотрим детально ниже.

**Логика агрегации:**
- Дневные агрегации рассчитываются в конце дня или по мере поступления записей
- Недельные агрегации рассчитываются в конце недели
- Месячные агрегации рассчитываются в конце месяца
- Результаты агрегации используются для обновления портрета пользователя

### 4. Archetype Service
Определение и обновление психологического архетипа.

**Получает события:**
- MoodAnalyzed
- DiaryEntryCreated (для подсчёта токенов)

**Генерирует события:**
- ArchetypeCalculationTriggered (когда достигнут порог токенов)
- ArchetypeAssigned
- ArchetypeUpdated

**Логика:** накапливает данные о паттернах эмоций, темах, стиле письма. После достижения порога (например, 10000 токенов) запускает анализ и определяет архетип. Использует агрегированные данные из Mood Analysis Service для построения полного портрета пользователя.

### 5. Analytics Service
Агрегация данных для визуализации динамики.

**Получает события:**
- MoodAnalyzed
- DiaryEntryCreated
- ArchetypeUpdated

**Предоставляет:**
- динамика настроения по дням/неделям/месяцам
- частота записей
- темы и ключевые слова во времени
- корреляции (например, день недели и настроение)

### 6. Search Service
Полнотекстовый поиск по записям.

**Получает события:**
- DiaryEntryCreated
- DiaryEntryUpdated
- DiaryEntryDeleted

**Технология:** Elasticsearch или Meilisearch для индексации и поиска.

### 7. Biometric Service (второй этап)
Интеграция данных с носимых устройств.

**События:**
- BiometricDataReceived
- BiometricAnomalyDetected

**Данные:** пульс, вариабельность сердечного ритма (HRV), уровень активности, качество сна.

### 8. Notification Service
Уведомления и напоминания.

**Функции:** напоминания о ведении дневника, уведомления об изменении архетипа, алерты при обнаружении тревожных паттернов.

---

## Хранение и обработка данных пользователя

### Многоуровневая система хранения

Система использует гибкий подход к хранению данных пользователя, обеспечивая возможность легкого добавления новых модальностей:

1. **Event Store (EventStoreDB)** - хранит все события системы в неизменяемом виде
2. **Read Models (Cassandra)** - хранит агрегированные данные для быстрого доступа
3. **Time-series данные** - хранят временные ряды эмоционального состояния с разными гранулярностями
4. **Profile Store** - хранит текущий портрет пользователя и его метаданные

### Структура портрета пользователя

**UserPortrait** содержит:
- Базовая информация (демография, предпочтения)
- Эмоциональные характеристики (базовые эмоции, валентность, возбуждение)
- Поведенческие паттерны (частота записей, активность по времени)
- Тематические предпочтения (ключевые темы, интересы)
- Архетипические характеристики (юнггианские архетипы, Big Five traits)
- Модальности (текст, биометрия и др. с весами)
- Временные метрики (дневные/недельные/месячные тренды)

### Агрегация данных по временным промежуткам

Система обрабатывает данные пользователя с разной временной гранулярностью:

1. **Дневная агрегация**:
   - Рассчитывается в конце дня или по мере поступления записей
   - Содержит средние эмоциональные показатели за день
   - Учитывает количество и качество записей

2. **Недельная агрегация**:
   - Рассчитывается в конце недели
   - Содержит тренды и паттерны за неделю
   - Выявляет недельные циклы и закономерности

3. **Месячная агрегация**:
   - Рассчитывается в конце месяца
   - Содержит долгосрочные тренды и изменения
   - Используется для обновления архетипа и портрета

### Добавление новых модальностей

Система спроектирована для легкого добавления новых модальностей:

1. **Модульная структура** - каждая модальность обрабатывается отдельным сервисом
2. **Единый формат событий** - все модальности генерируют события в стандартном формате
3. **Гибкая схема хранения** - Cassandra позволяет легко добавлять новые поля
4. **Весовая система** - каждая модальность имеет вес в общем портрете пользователя
5. **Адаптивная агрегация** - система автоматически учитывает новые модальности при агрегации

### Мэтчинг пользователей и ресурсов

На основе портретов пользователей система может:

1. **Находить похожих пользователей** - по эмоциональным профилям, интересам, архетипам
2. **Рекомендовать контент** - на основе предпочтений и текущего состояния
3. **Группировать пользователей** - для совместных сессий или исследований
4. **Анализировать корреляции** - между разными пользователями и их состояниями

---

## Event Sourcing: детали реализации

### Event Store

Структура события:
- ID события (UUID)
- тип события (строка, например "DiaryEntryCreated")
- ID агрегата (ID пользователя или записи)
- версия агрегата (для оптимистичной блокировки)
- временная метка
- payload (JSON с данными события)
- метаданные (ID корреляции, ID причинности для трассировки)

**Технологии на выбор:**
- EventStoreDB — специализированная БД для event sourcing
- PostgreSQL с таблицей событий — проще, достаточно для курсовой
- Apache Kafka — если нужен высокий throughput

### CQRS (Command Query Responsibility Segregation)

**Write-сторона:** команды обрабатываются, генерируют события, события сохраняются в Event Store.

**Read-сторона:** проекции слушают события и обновляют read-модели (денормализованные таблицы для быстрого чтения).

Пример проекций:
- DiaryEntriesProjection — текущее состояние всех записей пользователя
- MoodTimelineProjection — временной ряд настроения
- SessionsProjection — сгруппированные по сессиям записи

---

## Модели машинного обучения

### Анализ настроения (Mood Analysis)

**Базовая модель для старта:**
- RuBERT или RuGPT для русского языка
- Предобученные модели для sentiment analysis: DeepPavlov, dostoevsky

**Что определяем:**
- Базовые эмоции по модели Плутчика: радость, доверие, страх, удивление, грусть, отвращение, гнев, предвкушение
- Интенсивность эмоций (шкала 0-1)
- Валентность (положительная/отрицательная)
- Возбуждение (arousal)

**Выход модели:** вектор из 8+ значений (по количеству базовых эмоций) + метрики уверенности.

### Определение архетипа

**Теоретическая основа:** Юнгианские архетипы (12 классических) или Big Five personality traits, или комбинация.

**12 архетипов Юнга:**
Невинный, Мудрец, Искатель, Бунтарь, Маг, Герой, Любовник, Шут, Простодушный, Заботливый, Творец, Правитель

**Входные признаки для определения архетипа:**
- агрегированные эмоции за весь период
- тематический анализ текстов (о чём пишет человек)
- стиль письма (длина предложений, сложность лексики, использование местоимений)
- паттерны активности (когда пишет, как часто)
- динамика эмоций (стабильность/волатильность)

**Подход к классификации:**
- Первый вариант: мультиклассовая классификация на 12 архетипов
- Второй вариант: определение вероятности каждого архетипа (человек может иметь черты нескольких)

### Путь к собственным данным

**Этап 1: Использование готовых моделей**
- Берём предобученные модели для sentiment analysis
- Используем zero-shot классификацию для архетипов через LLM (GPT-4, Claude)

**Этап 2: Сбор собственных данных**
- Пользователи системы генерируют данные
- Добавляем возможность ручной разметки (самооценка настроения)
- Накапливаем достаточный объём (тысячи записей от десятков пользователей)

**Этап 3: Fine-tuning**
- Дообучаем базовую модель (RuBERT) на собственных данных с разметкой
- Используем техники: LoRA для эффективного дообучения, few-shot learning
- Валидация: отложенная выборка, кросс-валидация

**Этап 4: Активное обучение**
- Система показывает пользователю случаи с низкой уверенностью
- Пользователь подтверждает или корректирует
- Модель постепенно улучшается на реальных данных

---

## Интеграция биометрических данных (этап 2)

### Источники данных

**Умные часы и фитнес-трекеры:**
- Apple Watch (HealthKit API)
- Samsung Galaxy Watch (Samsung Health API)
- Fitbit (Web API)
- Garmin (Connect API)
- Xiaomi/Amazfit (неофициальные API)

### Полезные метрики

- **HRV (вариабельность сердечного ритма)** — индикатор стресса и восстановления
- **Пульс покоя** — долгосрочный индикатор здоровья и стресса
- **Качество сна** — длительность, фазы, пробуждения
- **Уровень активности** — шаги, калории, тренировки
- **Уровень кислорода в крови (SpO2)** — если доступно

### Корреляция с эмоциональным состоянием

Система ищет паттерны:
- Связь между плохим сном и негативными записями
- Влияние физической активности на настроение
- Стресс (по HRV) и эмоциональные записи
- Временные лаги (плохой сон → плохое настроение через день)

### Архитектура интеграции

Biometric Ingestion Service — получает данные от различных API, нормализует в единый формат, генерирует события BiometricDataReceived.

Correlation Service — анализирует совпадения между биометрикой и текстовым анализом, обогащает эмоциональный портрет.

---

## Технологический стек

### Backend
- **Язык:** Go — хорошо подходит для микросервисов, знаком тебе
- **API Gateway:** Kong или самописный на Go
- **Message Broker:** NATS JetStream (для event sourcing хорошо подходит, низкая латентность) или RabbitMQ
- **Event Store:** PostgreSQL (для курсовой достаточно) или EventStoreDB

### Базы данных
- **PostgreSQL** — основное хранилище, события, read-модели
- **Redis** — кэширование, сессии
- **Elasticsearch** — полнотекстовый поиск

### ML-инфраструктура
- **Python** — для ML-сервисов (отдельные микросервисы)
- **FastAPI** — API для ML-моделей
- **PyTorch/Transformers** — работа с моделями
- **MLflow** — отслеживание экспериментов и версионирование моделей

### Frontend
- **React/Next.js** или **Vue/Nuxt** — веб-интерфейс
- **React Native** или **Flutter** — мобильное приложение (опционально)

### Инфраструктура
- **Docker** — контейнеризация
- **Docker Compose** — для локальной разработки
- **Kubernetes** — для продакшена (опционально для курсовой)

---

## Структура данных и временные агрегации

### Иерархия времени

**Сессия** — один сеанс взаимодействия с дневником (от открытия до закрытия).

**День** — все записи за календарный день, агрегированное настроение дня.

**Неделя** — агрегация по неделям, тренды.

**Месяц** — долгосрочные паттерны.

### Read-модели для аналитики

DailyMoodSummary:
- дата
- средний вектор эмоций
- доминирующая эмоция
- количество записей
- общее количество токенов
- индекс волатильности настроения

WeeklyMoodSummary:
- номер недели и год
- тренд (улучшение/ухудшение/стабильность)
- самый эмоциональный день
- ключевые темы недели

MonthlyMoodSummary:
- месяц и год
- общая характеристика периода
- сравнение с предыдущим месяцем
- вклад в архетип

---

## Пороги и триггеры

### Определение архетипа

**Первичное определение:** после накопления 10000 токенов (примерно 20-30 развёрнутых записей).

**Обновление:** пересчёт каждые 5000 новых токенов или раз в месяц.

**Отображение:** показываем архетип только когда уверенность модели выше порога (например, 0.7).

### Алерты и рекомендации

**Тревожные паттерны:**
- Резкое падение настроения (более 2 стандартных отклонений от среднего)
- Длительный период негативных эмоций (более 7 дней)
- Ключевые слова, связанные с депрессией или тревогой

**Важно:** система не ставит диагнозы, только предлагает обратить внимание или поговорить со специалистом.

---

## Поток данных (пример)

1. Пользователь открывает дневник → DiarySessionStarted
2. Пользователь пишет запись → DiaryEntryCreated
3. Mood Analysis Service получает событие → запускает анализ → MoodAnalyzed
4. Analytics Service обновляет агрегаты дня/недели/месяца
5. Search Service индексирует запись
6. Archetype Service проверяет порог токенов → если достигнут, запускает анализ → ArchetypeAssigned
7. User Service обновляет профиль пользователя

---

## Рекомендуемый порядок реализации

**Фаза 1 (MVP):**
- User Service (базовая авторизация, хранение профиля)
- Diary Service (CRUD записей, event sourcing)
- Mood Analysis Service (анализ настроения, агрегация по времени)
- Базовая структура портрета пользователя
- Мобильное приложение (Swift)

**Фаза 2:**
- Analytics Service (углубленные агрегации по времени)
- Archetype Service (определение психологических архетипов)
- Система мэтчинга пользователей
- Улучшенная визуализация данных

**Фаза 3:**
- Search Service
- Добавление новых модальностей (биометрия и др.)
- Улучшенные алгоритмы анализа
- Сбор данных для дообучения моделей

**Фаза 4:**
- Biometric Service
- Correlation Service
- Расширенная система рекомендаций
- Социальные функции

---

Если нужно углубиться в какую-то конкретную часть — спрашивай. Могу детальнее расписать event sourcing паттерны, схему базы данных, или подход к обучению моделей.