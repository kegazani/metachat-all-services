version: "3.9"

services:
  registry:
    image: registry:2
    ports:
      - "5000:5000"
    volumes:
      - registry_data:/var/lib/registry
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: "[*]"
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  registry-ui:
    image: joxit/docker-registry-ui:main
    ports:
      - "5001:80"
    environment:
      REGISTRY_TITLE: "MetaChat Registry"
      REGISTRY_URL: "http://registry:5000"
      SINGLE_REGISTRY: "true"
      DELETE_IMAGES: "true"
      SHOW_CONTENT_DIGEST: "true"
      NGINX_PROXY_PASS_URL: "http://registry:5000"
    networks:
      - metachat_network
    depends_on:
      - registry
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  traefik:
    image: traefik:v3.0
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=metachat_network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--accesslog=true"
      - "--ping=true"
    ports:
      - "80:80"
      - "443:443"
      - "8088:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"

  api-gateway:
    image: ${REGISTRY:-localhost:5000}/metachat/api-gateway:${TAG:-latest}
    environment:
      - SERVICES_USER_SERVICE_ADDRESS=user-service:50051
      - SERVICES_DIARY_SERVICE_ADDRESS=diary-service:50052
      - SERVICES_MATCHING_SERVICE_ADDRESS=matching-service:50053
      - SERVICES_MATCH_REQUEST_SERVICE_ADDRESS=match-request-service:50054
      - SERVICES_CHAT_SERVICE_ADDRESS=chat-service:50055
      - SERVER_PORT=8080
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api-gateway.rule=PathPrefix(`/api`)"
        - "traefik.http.services.api-gateway.loadbalancer.server.port=8080"
        - "traefik.http.services.api-gateway.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.api-gateway.loadbalancer.healthcheck.interval=10s"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  user-service:
    image: ${REGISTRY:-localhost:5000}/metachat/user-service:${TAG:-latest}
    environment:
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - EVENT_STORE_TYPE=eventstoredb
      - EVENT_STORE_URL=http://eventstore:2113
      - SERVER_PORT=8080
      - GRPC_PORT=50051
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  diary-service:
    image: ${REGISTRY:-localhost:5000}/metachat/diary-service:${TAG:-latest}
    environment:
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - EVENT_STORE_TYPE=eventstoredb
      - EVENT_STORE_URL=http://eventstore:2113
      - SERVER_PORT=8080
      - GRPC_PORT=50052
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  matching-service:
    image: ${REGISTRY:-localhost:5000}/metachat/matching-service:${TAG:-latest}
    environment:
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8080
      - GRPC_PORT=50053
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  match-request-service:
    image: ${REGISTRY:-localhost:5000}/metachat/match-request-service:${TAG:-latest}
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=metachat
      - SERVER_PORT=50054
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  chat-service:
    image: ${REGISTRY:-localhost:5000}/metachat/chat-service:${TAG:-latest}
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=metachat
      - SERVER_PORT=50055
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  mood-analysis-service:
    image: ${REGISTRY:-localhost:5000}/metachat/mood-analysis-service:${TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8000
      - GRPC_PORT=50056
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  analytics-service:
    image: ${REGISTRY:-localhost:5000}/metachat/analytics-service:${TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8000
      - GRPC_PORT=50057
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  archetype-service:
    image: ${REGISTRY:-localhost:5000}/metachat/archetype-service:${TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8000
      - GRPC_PORT=50058
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  biometric-service:
    image: ${REGISTRY:-localhost:5000}/metachat/biometric-service:${TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8000
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  correlation-service:
    image: ${REGISTRY:-localhost:5000}/metachat/correlation-service:${TAG:-latest}
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:29092
      - CASSANDRA_HOSTS=cassandra:9042
      - CASSANDRA_KEYSPACE=metachat
      - SERVER_PORT=8000
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure

  grafana:
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-metachat2024}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://localhost:3000"
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.grafana.rule=PathPrefix(`/grafana`)"
        - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  blackbox:
    image: prom/blackbox-exporter:latest
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./monitoring/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - metachat_network
    deploy:
      mode: global
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  node-exporter:
    image: prom/node-exporter:latest
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - metachat_network
    deploy:
      mode: global
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M

  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "5002:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - metachat_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

volumes:
  registry_data:
  prometheus_data:
  grafana_data:

networks:
  metachat_network:
    external: true
    name: metachat_network

